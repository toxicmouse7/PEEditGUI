Задание.

Реализовать консольную или графическую программу редактирования PE-файлов (форматы PE32 и PE32+). После модификации файл должен оставаться корректным PE-файлом и сохранять возможность запуска (это и есть критерий корректности) с учётом внесённых изменений (т.е. при запуске должен проявляться эффект внесённых изменений). Ошибка запуска допускается только в случае ввода пользователем (в тех случаях, где это предполагается) заведомо некорректных данных.
Для консольной программы все параметры и команды редактирования должны передаваться через аргументы командной строки. Не допускаются иные способы взаимодействия с пользователем (например, через стандартный ввод).


Базовая функциональность (к сдаче не принимаются задания с функциональностью меньше базовой).
15 баллов.
Требования:
1. Поддерживать один из форматов PE32 или PE32+.
2. Редактирование основных полей NT-заголовка (сигнатура "PE", NumberOfSections, TimeDateStamp, SizeOfOptionalHeader, Characteristics, Magic, AddressOfEntryPoint, ImageBase, SectionAlignment, FileAlignment, SizeOfImage, SizeOfHeaders, Subsystem, NumberOfRvaAndSizes)
3. Редактирование всех полей элементов таблицы секций.
4. Обнуление элементов (адрес, размер) таблицы директорий.


Дополнительные задания.
Выбрать не более трёх (из пяти) дополнительных заданий (для каждого задания любое число подзаданий).

1. Модификация таблицы релоков:
1) Модификация заголовка блока (размер, адрес), модификация элемента блока (тип, смещение).
2 балла.
2) Перенастройка всех корректируемых адресов на новый базовый адрес загрузки (с соответствующей корректировкой ImageBase).
2 балла.
3) Добавление нового блока, добавление нового элемента в блок (необходимо найти дополнительную память).
2 балла.

2. Модификация таблицы импорта.
1) Модификация имени библиотеки, модификация имени импортируемой функции.
2 балла.
+2 балла за возможность указать новые имена библиотек и функций длиннее исходных (необходимо найти дополнительную память).
2) Добавление дескриптора импорта, добавление новой функции в дескриптор импорта (необходимо найти дополнительную память).
5 баллов.

3. Модификация таблицы экспорта.
1) Модификация имени экспортируемой функции, адреса экспортируемой функции (по имени, по ординалу).
2 балла.
+2 балла за возможность указать новые имена библиотек и функций длиннее исходных (необходимо найти дополнительную память).
2) Добавление новой функции (в массив адресов), добавление нового имени функции (в массив имён) (необходимо найти дополнительную память).
2 балла.
3) Перенаправление функции в другую библиотеку (необходимо найти дополнительную память).
2 балла.

4. Расширение размера файла (добавление новой секции либо расширение последней) для размещения добавляемых элементов (может понадобиться для других пунктов задания). Память должна расширяться не более одного раза за один запуск. Т.е. надо подсчитывать суммарный размер всех необходимых расширений, требуемых для модификаций текущего запуска, и один раз осуществлять расширение на этот размер.
5 баллов.

5. Для всей реализуемой функциональности поддерживать оба формата (PE32 и PE32+), динамически определяя формат при анализе файла.
5 баллов.



Указания и рекомендации.

Простое редактирование PE-файла (без увеличения размера) заключается в считывании файла в буфер, изменении нужных байт в буфере и записи буфера обратно на диск. При этом редактирование некоторых полей будет требовать обращение по относительным виртуальным адресам (RVA), которые корректны в загруженном образе программы. В данном же случае файл в памяти представляет из себя копию данных в файле, поэтому необходимо будет переводить RVA в файловые смещения (и их уже прибавлять к адресу начала буфера).

Некоторые задания предполагают добавление новых элементов (или увеличение существующих). Для их размещения потребуется дополнительная память (в которой будут располагаться эти новые элементы либо в которую будет скопирована существующая таблица с новыми добавленными элементами). Без увеличения размера файла эту память можно поискать в области нулей выравнивания в конце секций. Более универсальным решением будет увеличение размера файла (если в конце PE-файла добавить произвольные байты, то его работоспособность не нарушится). Но простого увеличения файла будет недостаточно. Необходимо, чтобы новые данные проецировались при загрузке в образ программы, а для этого они должны попасть в какую-то секцию. Для этого можно добавить новую секцию (которой будут принадлежать новые данные файла) либо расширить последнюю (расширив её размер в файле за счёт новых данных).

